<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">  
  <xacro:macro name="caster_wheel_macro" params="robot_namespace prefix wheel_mass wheel_radius wheel_length mount_height fork_to_mount_offset_z wheel_to_fork_offset_z parent *origin">
    <link name="${robot_namespace}/${prefix}_mount_link">
      <visual>
        <geometry>
          <box size="0.1145 0.1 ${mount_height}"/>
        </geometry>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <material name="black"/>
      </visual>

      <collision>
        <geometry>
          <box size="0.1145 0.1 ${mount_height}"/>
        </geometry>
        <origin rpy="0 0 0" xyz="0 0 0"/>
      </collision>
      
      <inertial>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <mass value="0.25"/>
        <inertia ixx="0.000209010208333" ixy="0" ixz="0" iyy="0.000273807083333" iyz="0" izz="0.000273807083333"/>
      </inertial>
    </link>
  
    <joint name="${robot_namespace}/${prefix}_mount_joint" type="fixed">
      <parent link="${robot_namespace}/${parent}"/>
      <child link="${robot_namespace}/${prefix}_mount_link"/>
      <xacro:insert_block name="origin"/>
    </joint>

    <link name="${robot_namespace}/${prefix}_fork_link">
      <visual>
        <geometry>
          <box size="0.02 0.02 0.02"/>
        </geometry>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <material name="black"/>
      </visual>

      <collision>
        <geometry>
          <box size="0.02 0.02 0.02"/>
        </geometry>
        <origin rpy="0 0 0" xyz="0 0 0"/>
      </collision>
      
      <inertial>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <mass value="1.5"/>
        <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001"/>
      </inertial>
    </link>

    <joint name="${robot_namespace}/${prefix}_fork_joint" type="continuous">
      <axis rpy="0 0 0" xyz="0 0 1"/>
      <parent link="${robot_namespace}/${prefix}_mount_link"/>
      <child link="${robot_namespace}/${prefix}_fork_link"/>
      <origin xyz="0 0 ${fork_to_mount_offset_z}"/>
      <dynamics damping="0.0" friction="0.15"/>
    </joint>

    <link name="${robot_namespace}/${prefix}_wheel_link">
      <visual>
        <geometry>
          <cylinder length="${wheel_length}" radius="${wheel_radius}"/>
        </geometry>
        <origin rpy="${pi/2} 0 0" xyz="0 0 0"/>
        <material name="orange"/>
      </visual>

      <collision>
        <geometry>
          <cylinder length="${wheel_length}" radius="${wheel_radius}"/>
        </geometry>
        <origin rpy="${pi/2} 0 0" xyz="0 0 0"/>
      </collision>
      
      <inertial>
        <origin rpy="${pi/2} 0 0" xyz="0 0 0"/>
        <mass value="${wheel_mass}"/>
        <xacro:solid_cylinder_inertia_macro mass="${wheel_mass}" radius="${wheel_radius}" height="${wheel_length}"/>
      </inertial>
    </link>
  
    <joint name="${robot_namespace}/${prefix}_wheel_joint" type="continuous">
      <axis rpy="0 0 0" xyz="0 1 0"/>
      <parent link="${robot_namespace}/${prefix}_fork_link"/>
      <child link="${robot_namespace}/${prefix}_wheel_link"/>
      <origin xyz="-0.037 0 ${wheel_to_fork_offset_z}"/>
      <dynamics damping="0.0" friction="0.15"/>
    </joint>

    <!-- Gazebo extensions -->
    <gazebo reference="${robot_namespace}/${prefix}_fork_link">
      <material>Gazebo/Grey</material>
    </gazebo>

    <gazebo reference="${robot_namespace}/${prefix}_mount_link">
      <material>Gazebo/Grey</material>
    </gazebo>

    <gazebo reference="${robot_namespace}/${prefix}_wheel_link">
      <material>Gazebo/Orange</material>
      <kp>1000000.0</kp>
      <kd>10.0</kd>
      <mu1>1.0</mu1>
      <mu2>1.0</mu2>
      <fdir1>1 0 0</fdir1>
      <maxVel>1.0</maxVel>
      <minDepth>0.00</minDepth>
    </gazebo>
  </xacro:macro>
</robot>